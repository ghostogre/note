1. `TCP`三次握手，归`HTTP`。
2. `TLS`握手，归`HTTPS`
3. `WebSocket`握手，基于`TCP`协议，都能用。

## TCP三次握手

**在实际的通信中，序号并不是从 1 开始的，而是需要用随机数计算出一个初始值，这是因为 如果序号都从 1 开始，通信过程就会非常容易预测，有人会利用这一点来发动攻击。**（如果从1开始的话，就可以根据现在的值是多少猜出是那一次通讯，因为是从1开始一直加1的）。如果初始值是随机的，那么对方就搞不清楚序号到底是从 多少开始计算的，因此需要在开始收发数据之前将初始值告知通信对象。

### 为什么需要三次握手呢？

三次握手流程

1. 客户端发出连接请求报文段，包括同步信号**SYN**（=1）， `ISN`（初始 seq 序列号为随机数x）和`ACK=0`。（客户端进入`SYN_SENT`状态）
2. 服务器收到连接请求报文后，如果同意连接，就会发送一个应答，`SYN=1`，`ACK=1`，`seq=y`，`ack=x+1`。(y是另一个随机数，服务器发送的初始序列号) 服务器进入`SYN_RECV`状态。
3. 当客户端收到连接同意的应答后，还要向服务端发送一个确认报文段，表示：服务端发来的连接同意应答已经成功收到。该报文段的头部为：`ACK=1`，`seq=x+1`，`ack=y+1`。

**答**：如果不是三次握手，是两次握手的话。那么如果第一个包延误了，服务器收到了就会发出确认报文，同意建立连接。但是这个包其实已经失效了，客户端也没有再发起建立连接的请求，但是服务器会一直处于等待状态，就会造成资源的浪费。**防止失效的连接请求报文段被服务端接收，从而产生错误**。

#### 扩展

第一个包丢失的话，客户端会周期性超时重传，直到收到确认。

第二个包丢失的话，服务器会周期性超时重传，直到收到确认。

第三个包丢失的话，客户端单方面established状态，服务器认为TCP为active状态。



## 四次挥手

1. A发起连接释放请求，该请求只有报文头，头中携带的主要参数为：`FIN=1`，`seq=u`。此时，A将进入`FIN-WAIT-1`状态。（u-1是A向B发送的最后一个字节的序号）

2. B收到连接释放请求后，会通知相应的应用程序，告诉它`A=>B`这个方向的连接已经释放。此时B进入CLOSE-WAIT状态，并向A发送连接释放的应答，其报文头包含：`ACK=1`，`seq=v`，`ack=u+1`。(v-1是B向A发送的最后一个字节的序号，ack=u+1表示希望收到从第u+1个字节开始的报文段，并且已经成功接收了前u个字节)。A收到该应答，进入FIN-WAIT-2状态，等待B发送连接释放请求。

   第二次挥手完成后，A到B方向的连接已经释放，B不会再接收数据，A也不会再发送数据。但B到A方向的连接仍然存在，B可以继续向A发送数据。

3. 当B向A发完所有数据后，向A发送连接释放请求，请求头：`FIN=1`，`ACK=1`，`seq=w`，`ack=u+1`。B便进入LAST-ACK状态。

4. A收到释放请求后，向B发送确认应答，此时A进入TIME-WAIT状态。该状态会持续2MSL时间，若该时间段内没有B的重发请求的话，就进入CLOSED状态，撤销TCB。当B收到确认应答后，也便进入CLOSED状态，撤销TCB。

**为什么A要先进入TIME-WAIT状态，等待2MSL时间后才进入CLOSED状态？** 
为了保证B能收到A的确认应答。 
若A发完确认应答后直接进入CLOSED状态，那么如果该应答丢失，B等待超时后就会重新发送连接释放请求，但此时A已经关闭了，不会作出任何响应，因此B永远无法正常关闭。

# HTTP 与 HTTPS 的区别

- HTTP 是明文传输，HTTPS 通过 `SSL\TLS` 进行了加密
- HTTP 的端口号是 80，HTTPS 是 443
- HTTPS 需要到 CA 申请证书，一般免费证书很少，需要交费
- HTTPS 的连接很简单，是无状态的；HTTPS 协议是由 `SSL+HTTP` 协议构建的可进行加密传输、身份认证的网络协议，比 HTTP 协议安全。

RSA（非对称加密算法）：双方必须协商一对密钥，一个私钥一个公钥。用私钥加密的数据，只有对应的公钥才能解密，用公钥加密的数据， 只有对应的私钥才能解密。（对称密钥也就是加密和解密使用的是同一个密钥）

但是这样有个弊端：

- RSA 算法很慢= =，要慢很多

所以为了解决这个问题，我们使用**非对称密钥+对称密钥**结合的方式

**结合两者的优点。使用 RSA 的方法将加密算法的对称密钥发送过去，之后就可以使用使用这个密钥，利用对称密钥来通信了。**

## 中间人攻击

还有一个问题就是在使用非对称密钥的时候，首先需要将 Bill 的公钥给张大胖，那么在这个过程中，安全是没有保障的，中间人可以拦截到 Bill 的公钥，就可以对拦截到的公钥进行篡改。

这个时候就需要公证处的存在了。也就是说我需要先将我的电话号码到公证处去公证一下，然后我将电话号码传给你之后，你在将你收到的电话号码和公证处的比对下，就知道是不是我的了。

对应到计算机世界，那就是数字签名。也就是专门的证书颁发单位进行验证。

## HTTPS握手

1. A向B发起连接请求（以明文传输请求信息，包含版本信息，加密-套件候选列表，压缩算法候选列表，随机数，扩展字段等信息）
2. B收到后返回一个公钥给A（采用HTTPS协议的服务器必须要有一套数字证书，可以自己制作，也可以向组织申请。区别就是自己颁发的证书需要客户端验证通过，才可以继续访问，而使用受信任的公司申请的证书则不会弹出提示页面。`这套证书其实就是一对公钥和私钥。）
3. A验证证书的合法性，包括可信性，是否吊销，过期时间和域名，客户端使用公匙对对称密匙加密，发送给服务端。
4. B收到后用私钥解密，拿到对称加密的密匙。

