## setState的流程

使用`prototype.setState`进行搜索，首先找到`packages\react\src\ReactBaseClasses.js`里的setState：

```ts
Component.prototype.setState = function(partialState, callback) {
  invariant(
    typeof partialState === 'object' ||
      typeof partialState === 'function' ||
      partialState == null,
    'setState(...): takes an object of state variables to update or a ' +
      'function which returns an object of state variables.',
  );
  debugger; // 添加断点
  this.updater.enqueueSetState(this, partialState, callback, 'setState');
};
```

在Chrome里面打开demo页面（使用script编写简单的渲染程序），然后执行setState，浏览器会执行到断点。

step into 执行`this.updater.enqueueSetState`，进入`src/ReactFiberClassComponent.new.js`

在`src/ReactFiberClassComponent.new.js`里定义了一个名为`classComponentUpdater`的对象，上面的enqueueSetState就是在这里做了具体的实现。

```ts
const classComponentUpdater = {
  isMounted,
  enqueueSetState(inst, payload, callback) {
    const fiber = getInstance(inst);
    const eventTime = requestEventTime();
    const suspenseConfig = requestCurrentSuspenseConfig();
    const lane = requestUpdateLane(fiber, suspenseConfig);

    const update = createUpdate(eventTime, lane, suspenseConfig);
    update.payload = payload;
    if (callback !== undefined && callback !== null) {
      if (__DEV__) {
        warnOnInvalidCallback(callback, 'setState');
      }
      update.callback = callback;
    }

    enqueueUpdate(fiber, update);
    scheduleUpdateOnFiber(fiber, lane, eventTime);
  },
  // ......
 }
```

第一步就是`const fiber = getInstance(inst);`(在浏览器里显示的是`const fiber = get(inst);`，这是因为这个方法是`import {get as getInstance, set as setInstance} from 'shared/ReactInstanceMap';`这样引入的)，我们可以在右侧看到call stack（函数调用栈）和scope（当前作用域里的变量）

我们可以看到 inst 也就是类组件的实例是如下的结构：

![](../images/inst.png)

然后我们进入到get，get的具体定义在`shared/ReactInstanceMap.js`中：

```ts
function get(key) {
    return key._reactInternals;
}
```

这里的key就是inst也就是类组件实例了：

![](../images/key.png)

可以看到返回的是fiberNode的对象。