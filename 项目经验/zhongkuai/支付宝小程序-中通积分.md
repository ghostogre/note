## 细节

1. 项目使用 dva 内置的`redux` + `redux-saga`。 在`app.tsx`直接导入store，就可以直接使用dvaApp的redux，以后`useSelector`和`useDispatch`。Taro默认会给你生成store目录，里面使用`redux`和`redux-thunk`

   ```jsx
   // dva.ts
   import Taro from '@tarojs/taro'
   import { create } from 'dva-core';
   import { useSelector, useDispatch } from '@tarojs/redux';
   import { createLogger } from 'redux-logger';
   // import createLoading from 'dva-loading';
   import immer from 'dva-immer';
   let app
   let store
   let dispatch
   let registered
   
   function createApp(opt) {
     // redux日志
     // opt.onAction = [createLogger()]
     app = create(opt)
     app.use(immer())
   
     // 防止重复注册
     if (!registered) opt.models.forEach(model => app.model(model))
     registered = true
     app.start()
   
     store = app._store
     app.getStore = () => store
     app.use({
       onError(err) {
         if(err.code!=212){
           Taro.showToast({
             title: err.message
           })
         }else{
           Taro.removeStorageSync('token')
           dispatch({type:'common/save', payload: {
             isLogin: false,
           }})
         }
         console.log(err);
       },
     })
   
     dispatch = store.dispatch
   
     app.dispatch = dispatch
     return app
   }
   
   export default {
     createApp,
     getDispatch() {
       return app.dispatch
     }
   }
   
   // app.tsx
   const dvaApp = dva.createApp({
     initialState: {},
     models: models,
   });
   
   const store = dvaApp.getStore();
   
   // render
   <Provider store={store}></Provider>
   ```

2. `git remote update origin --prune`  找不到新创建远程分支的时候使用，可能远程新创建了分支，但是本地的源没更新。

5. Taro一个函数只能有一个渲染函数。

6. `npm config get prefix`：查看全局包安装路径。

7. 命令行脚手架一般安装在 `C:\Program Files\nodejs` 下面的node_modules。

8. `git pull origin master`：在适当的时候，每一个个人分支都需要 `pull` 一下 `master` 分支，以保证自己本地的代码的版本不会低于服务器。

9. page的文件夹要用小写字母开头否则开发工具找不到。

10. eslint：`Absolute imports should come before relative imports`，绝对引入应该在相对地址引入的前面。

11. 不要在支付宝小程序里使用`PickerView`和`PickerViewColumn`的时候动态渲染，会报错而无法渲染，错误的引用微信小程序的组件。（其中只可放置 picker-view-column 组件，其它节点不会显示）

12. 在eslint里要使用`Number.isNaN`判断是不是NaN，而不是直接全局`isNaN`。

13. 使用Number可以将`''`转换成数字0，使用parseInt和直接乘以1会出现NaN的情况（undefined和非数字字符串）。

14. 支付宝的地图，文档上说是原生组件永远位于最高层级。但是实际上使用还是可以在上面显示其他东西的。支付宝的地图开发的时候，需要包裹一个父元素，高度依赖于父元素（flex布局实测无效，最好给父元素指定明确的高度，calc计算的高度也是可以的）。

15. **滚动穿透**：该项目里我采用的方法是设置页面刚好占满一屏，然后每次打开弹窗的时候，设置地图不可滚动。

14. 自定义hook不能顶层调用。

    ![img](./images/coupon.png)

    css实现思路参考：https://www.jianshu.com/p/3c652606e6d6

15. https://opendocs.alipay.com/mini/framework/performance-tips性能优化建议，官方建议减少层级嵌套和过多的节点。

## 踩坑

1. tarojs/cli偶尔会出现编译问题，明明在我的代码里props传值了，但是到编译后的代码就会出现props传值为undefined，而且时有时无。这种时候就需要我们**重新触发编译**。
2. 图片名称中不能存在空格，阿里云虽然支持转义空格，但是在小程序里还是会出现问题。
3. **taro脚手架的坑**：在win10中，2.2.4以及之前的版本，运行的时候会出现找不到`config/index`目录的问题。虽然说，官网说脚手架尽量与项目中保持一致，但是其实2.2.6脚手架运行2.2.4的项目是没问题的。
4. **开发工具的坑**：在开启支付宝小程序开发工具的时候，假如编译报错修复后会一直无法编译（即使反复确认没有错误），可能需要关闭开发工具，然后重新`yarn dev:alipay`。开发工具偶尔会出现请求不发送的情况，只能重启开发工具。
5. `CoverView`在支付宝小程序中无法点击。

## 平台差异

1. 透明渐变导航栏：支付宝小程序自己支持，在config里设置`"transparentTitle": "auto"`。
2. 带有扩展组件库，包含UI组件和营销组件。
3. API以`my.`开头。Taro 项目 支持 Taro 的代码与小程序（微信/百度/支付宝/字节跳动）原生的页面、组件代码混合存在
4. `Taro.getOpenUserInfo()`：此接口可获取支付宝会员的基础信息。如需获取支付宝会员标识（user_id），请调用 `my.getAuthCode `和 `alipay.system.oauth.token` 接口。
5. 支付宝diff算法有问题所以不能使用key。

## 我的贡献

1. 贡献业务代码。
2. 重构项目时，推动项目组使用duck扁平化数据。
3. 使用key-value方法代替if else判断，抽离代码集中管理（utils），提升了代码可复用性。
4. 优化代码中大量混乱的数据，集中到js文件中过管理。

## 难点

1. 首页翻牌抽奖，要在点击翻牌后才从后台获取抽奖结果，之后在获取奖品列表的形式。但是翻牌的顺序和奖品列表顺序是不同的？这要如何才能既要保证不重复，也要保证抽奖结果的位置不变。**我的思路：**记录抽奖结果的index，将抽奖结果id和抽奖列表数组进行对比，然后交换列表中结果index对应的奖品和抽奖结果。

2. redux中保存`statusBarHeight`和`titleBarHeight`，考虑到获取的statusBar高度和titleBar高度可能有问题，所以做好每次展示都获取一次（这种情况就不需要本地缓存了）

3. **背景图问题：**优惠券这类背景存在不透明的小缺口，而且容器本身还有图片背景，还得考虑到小程序兼容性问题。

   - **方案一**：考虑直接使用整张背景图，类似背景图上的大字也可以切到一张图上。但是这样的话类似优惠券有不同状态可能就需要我们自己判断一下再显示。背景图的话文字可能会比图先渲染，最好的方法是使用图片onload方法，使用一个变量控制img的display（`display:none`依然会加载图片），加载完成后再显示。（中间可以使用fadein等动效增加用户体验）
   - **方案二**：类似方案一，直接对整个优惠券使用淡入淡出动效，减少图片加载的闪烁的影响。
   - **方案三**：直接把圆形缺口的容器背景图切出来，作为伪元素，这样就看上去和透明的一样了。然后背景直接可以使用CSS实现，小圆缺口的图比较小也不会有加载问题。**缺点**就是要保证和容器背景图不会出现错位，而且优惠券列表的话，不同位置需要切多个不同的小圆切口的图。。。所以这个方法只适合比较少的列表或者纯色背景。
   - **方案四**：使用CSS的渐变来实现透明的小圆点到白色背景的效果，但是兼容性担忧。

   ![coupon.png](./images/coupon_1.png)

